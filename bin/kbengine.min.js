var __reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n},KBEngine;!function(e){e.PACKET_MAX_SIZE=1500,e.PACKET_MAX_SIZE_TCP=1460,e.PACKET_MAX_SIZE_UDP=1472,e.MESSAGE_ID_LENGTH=2,e.MESSAGE_LENGTH_LENGTH=2,e.CLIENT_NO_FLOAT=0,e.KBE_FLT_MAX=3.402823466e38}(KBEngine||(KBEngine={})),window.KBEngine=KBEngine,function(e){var t=function(){function e(e,t){this.sign=1,this.lo=e,this.hi=t,t>=2147483648&&(this.sign=-1,this.lo>0?(this.lo=4294967296-this.lo&4294967295,this.hi=4294967295-this.hi):(this.lo=4294967296-this.lo&4294967295,this.hi=4294967296-this.hi))}return e.prototype.toString=function(){var e="";this.sign<0&&(e+="-");var t=this.lo.toString(16),n=this.hi.toString(16);if(this.hi>0){e+=n;for(var r=8-t.length;r>0;--r)e+="0"}return e+=t},e}();e.INT64=t,__reflect(t.prototype,"KBEngine.INT64");var n=function(){function e(e,t){this.lo=e,this.hi=t}return e.prototype.toString=function(){var e=this.lo.toString(16),t=this.hi.toString(16),n="";if(this.hi>0){n+=t;for(var r=8-e.length;r>0;--r)n+="0"}return n+=e},e}();e.UINT64=n,__reflect(n.prototype,"KBEngine.UINT64")}(KBEngine||(KBEngine={})),function(e){function t(e){console.info(e)}function n(e){console.debug(e)}function r(e){console.error(e)}function a(e){console.warn(e)}e.INFO_MSG=t,e.DEBUG_MSG=n,e.ERROR_MSG=r,e.WARNING_MSG=a}(KBEngine||(KBEngine={})),function(e){function t(e){var t,n,r,a,i,o;for(t="",r=e.length,n=0;r>n;)switch(a=e[n++],a>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(a);break;case 12:case 13:i=e[n++],t+=String.fromCharCode((31&a)<<6|63&i);break;case 14:i=e[n++],o=e[n++],t+=String.fromCharCode((15&a)<<12|(63&i)<<6|(63&o)<<0)}return t}function n(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);128>r?t.push(r):2048>r?t.push(192|r>>6,128|63&r):55296>r||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(n++,r=65536+((1023&r)<<10|1023&e.charCodeAt(n)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return t}e.utf8ArrayToString=t,e.stringToUTF8Bytes=n}(KBEngine||(KBEngine={})),function(e){var t=function(){function e(e,t){this.callbackfn=t,this.classinst=e}return e}();e.EventInfo=t,__reflect(t.prototype,"KBEngine.EventInfo");var n=function(){function n(){this._events={}}return n.prototype.register=function(n,r,a){var i=r[a];if(void 0==i)return void e.ERROR_MSG("export class Event::fire: not found strCallback("+r+")!"+a);var o=this._events[n];void 0==o&&(o=[],this._events[n]=o);var p=new t(r,i);o.push(p)},n.prototype.deregister=function(e,t){for(var n in this._events)for(var r=this._events[n];;){for(var a=!1,i=0;i<r.length;i++){var o=r[i];if(o.classinst==t){r.splice(i,1),a=!0;break}}if(!a)break}},n.prototype.fire=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(!t)return void e.ERROR_MSG("export class Event::fire: not found eventName!");var a=this._events[t];if(void 0!=a)for(var i=0;i<a.length;i++){var o=a[i];o.callbackfn.apply(o.classinst,n||[])}},n}();e.Events=n,__reflect(n.prototype,"KBEngine.Events"),e.Event=new n}(KBEngine||(KBEngine={})),function(e){var t=function(){function t(e){this.rpos=0,this.wpos=0,e instanceof ArrayBuffer?this.buffer=e:this.buffer=new ArrayBuffer(e),this.rpos=0,this.wpos=0}return t.prototype.readInt8=function(){var e=new Int8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},t.prototype.readInt16=function(){var e=this.readUint16();return e>=32768&&(e-=65536),e},t.prototype.readInt32=function(){var e=this.readUint32();return e>=2147483648&&(e-=4294967296),e},t.prototype.readInt64=function(){return new e.INT64(this.readUint32(),this.readUint32())},t.prototype.readUint8=function(){var e=new Uint8Array(this.buffer,this.rpos,1);return this.rpos+=1,e[0]},t.prototype.readUint16=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=2,((255&e[1])<<8)+(255&e[0])},t.prototype.readUint32=function(){var e=new Uint8Array(this.buffer,this.rpos);return this.rpos+=4,(e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0]},t.prototype.readUint64=function(){return new e.UINT64(this.readUint32(),this.readUint32())},t.prototype.readFloat=function(){var e;try{e=new Float32Array(this.buffer,this.rpos,1)}catch(t){e=new Float32Array(this.buffer.slice(this.rpos,this.rpos+4))}return this.rpos+=4,e[0]},t.prototype.readDouble=function(){var e;try{e=new Float64Array(this.buffer,this.rpos,1)}catch(t){e=new Float64Array(this.buffer.slice(this.rpos,this.rpos+8),0,1)}return this.rpos+=8,e[0]},t.prototype.readString=function(){for(var e=new Uint8Array(this.buffer,this.rpos),t=0,n="";;){if(0==e[t]){t++;break}if(n+=String.fromCharCode(e[t]),t++,this.rpos+t>=this.buffer.byteLength)throw new Error("export class MemoryStream::readString: rpos("+(this.rpos+t)+")>="+this.buffer.byteLength+" overflow!")}return this.rpos+=t,n},t.prototype.readBlob=function(){var e=this.readUint32(),t=new Uint8Array(this.buffer,this.rpos,e);return this.rpos+=e,t},t.prototype.readStream=function(){var e=new Uint8Array(this.buffer,this.rpos,this.buffer.byteLength-this.rpos);return this.rpos=this.buffer.byteLength,new t(e)},t.prototype.readPackXZ=function(){var e=new t.PackFloatXType,n=new t.PackFloatXType;e.fv[0]=0,n.fv[0]=0,e.uv[0]=1073741824,n.uv[0]=1073741824;var r=this.readUint8(),a=this.readUint8(),i=this.readUint8(),o=0;o|=r<<16,o|=a<<8,o|=i,e.uv[0]|=(8384512&o)<<3,n.uv[0]|=(2047&o)<<15,e.fv[0]-=2,n.fv[0]-=2,e.uv[0]|=(8388608&o)<<8,n.uv[0]|=(2048&o)<<20;var p=new Array(2);return p[0]=e.fv[0],p[1]=n.fv[0],p},t.prototype.readPackY=function(){var e=this.readUint16();return e},t.prototype.writeInt8=function(e){var t=new Int8Array(this.buffer,this.wpos,1);t[0]=e,this.wpos+=1},t.prototype.writeInt16=function(e){this.writeInt8(255&e),this.writeInt8(e>>8&255)},t.prototype.writeInt32=function(e){for(var t=0;4>t;t++)this.writeInt8(e>>8*t&255)},t.prototype.writeInt64=function(e){this.writeInt32(e.lo),this.writeInt32(e.hi)},t.prototype.writeUint8=function(e){var t=new Uint8Array(this.buffer,this.wpos,1);t[0]=e,this.wpos+=1},t.prototype.writeUint16=function(e){this.writeUint8(255&e),this.writeUint8(e>>8&255)},t.prototype.writeUint32=function(e){for(var t=0;4>t;t++)this.writeUint8(e>>8*t&255)},t.prototype.writeUint64=function(e){this.writeUint32(e.lo),this.writeUint32(e.hi)},t.prototype.writeFloat=function(e){try{var t=new Float32Array(this.buffer,this.wpos,1);t[0]=e}catch(n){var t=new Float32Array(1);t[0]=e;var r=new Uint8Array(this.buffer),a=new Uint8Array(t.buffer);r.set(a,this.wpos)}this.wpos+=4},t.prototype.writeDouble=function(e){try{var t=new Float64Array(this.buffer,this.wpos,1);t[0]=e}catch(n){var t=new Float64Array(1);t[0]=e;var r=new Uint8Array(this.buffer),a=new Uint8Array(t.buffer);r.set(a,this.wpos)}this.wpos+=8},t.prototype.writeBlob=function(t){var n=t.length;if(n+4>this.space())return void e.ERROR_MSG("memorystream::writeBlob: no free!");this.writeUint32(n);var r=new Uint8Array(this.buffer,this.wpos,n);if("string"==typeof t)for(var a=0;n>a;a++)r[a]=t.charCodeAt(a);else for(var a=0;n>a;a++)r[a]=t[a];this.wpos+=n},t.prototype.writeString=function(t){if(t.length>this.space())return void e.ERROR_MSG("memorystream::writeString: no free!");for(var n=new Uint8Array(this.buffer,this.wpos),r=0,a=0;a<t.length;a++)n[r++]=t.charCodeAt(a);n[r++]=0,this.wpos+=r},t.prototype.readSkip=function(e){this.rpos+=e},t.prototype.space=function(){return this.buffer.byteLength-this.wpos},t.prototype.length=function(){return this.wpos-this.rpos},t.prototype.readEOF=function(){return this.buffer.byteLength-this.rpos<=0},t.prototype.done=function(){this.rpos=this.wpos},t.prototype.getbuffer=function(e){return this.buffer.slice(this.rpos,this.wpos)},t}();e.MemoryStream=t,__reflect(t.prototype,"KBEngine.MemoryStream"),function(e){var t=function(){function e(){this._unionData=new ArrayBuffer(4),this.fv=new Float32Array(this._unionData,0,1),this.uv=new Uint32Array(this._unionData,0,1),this.iv=new Int32Array(this._unionData,0,1)}return e}();e.PackFloatXType=t,__reflect(t.prototype,"KBEngine.MemoryStream.PackFloatXType")}(t=e.MemoryStream||(e.MemoryStream={}))}(KBEngine||(KBEngine={})),function(e){function t(){e.datatype2id={},e.datatype2id.STRING=1,e.datatype2id["STD::STRING"]=1,e.datatype2id.UINT8=2,e.datatype2id.BOOL=2,e.datatype2id.DATATYPE=2,e.datatype2id.CHAR=2,e.datatype2id.DETAIL_TYPE=2,e.datatype2id.ENTITYCALL_CALL_TYPE=2,e.datatype2id.UINT16=3,e.datatype2id["UNSIGNED SHORT"]=3,e.datatype2id.SERVER_ERROR_CODE=3,e.datatype2id.ENTITY_TYPE=3,e.datatype2id.ENTITY_PROPERTY_UID=3,e.datatype2id.ENTITY_METHOD_UID=3,e.datatype2id.ENTITY_SCRIPT_UID=3,e.datatype2id.DATATYPE_UID=3,e.datatype2id.UINT32=4,e.datatype2id.UINT=4,e.datatype2id["UNSIGNED INT"]=4,e.datatype2id.ARRAYSIZE=4,e.datatype2id.SPACE_ID=4,e.datatype2id.GAME_TIME=4,e.datatype2id.TIMER_ID=4,e.datatype2id.UINT64=5,e.datatype2id.DBID=5,e.datatype2id.COMPONENT_ID=5,e.datatype2id.INT8=6,e.datatype2id.COMPONENT_ORDER=6,e.datatype2id.INT16=7,e.datatype2id.SHORT=7,e.datatype2id.INT32=8,e.datatype2id.INT=8,e.datatype2id.ENTITY_ID=8,e.datatype2id.CALLBACK_ID=8,e.datatype2id.COMPONENT_TYPE=8,e.datatype2id.INT64=9,e.datatype2id.PYTHON=10,e.datatype2id.PY_DICT=10,e.datatype2id.PY_TUPLE=10,e.datatype2id.PY_LIST=10,e.datatype2id.ENTITYCALL=10,e.datatype2id.BLOB=11,e.datatype2id.UNICODE=12,e.datatype2id.FLOAT=13,e.datatype2id.DOUBLE=14,e.datatype2id.VECTOR2=15,e.datatype2id.VECTOR3=16,e.datatype2id.VECTOR4=17,e.datatype2id.FIXED_DICT=18,e.datatype2id.ARRAY=19}function n(t,n){switch(n){case e.datatype2id.UINT8:return t.writeUint8;case e.datatype2id.UINT16:return t.writeUint16;case e.datatype2id.UINT32:return t.writeUint32;case e.datatype2id.UINT64:return t.writeUint64;case e.datatype2id.INT8:return t.writeInt8;case e.datatype2id.INT16:return t.writeInt16;case e.datatype2id.INT32:return t.writeInt32;case e.datatype2id.INT64:return t.writeInt64;case e.datatype2id.FLOAT:return t.writeFloat;case e.datatype2id.DOUBLE:return t.writeDouble;case e.datatype2id.STRING:return t.writeString;case e.datatype2id.FIXED_DICT:return t.writeStream;case e.datatype2id.ARRAY:return t.writeStream;default:return t.writeStream}}function r(t){switch(t){case e.datatype2id.UINT8:return e.reader.readUint8;case e.datatype2id.UINT16:return e.reader.readUint16;case e.datatype2id.UINT32:return e.reader.readUint32;case e.datatype2id.UINT64:return e.reader.readUint64;case e.datatype2id.INT8:return e.reader.readInt8;case e.datatype2id.INT16:return e.reader.readInt16;case e.datatype2id.INT32:return e.reader.readInt32;case e.datatype2id.INT64:return e.reader.readInt64;case e.datatype2id.FLOAT:return e.reader.readFloat;case e.datatype2id.DOUBLE:return e.reader.readDouble;case e.datatype2id.STRING:return e.reader.readString;case e.datatype2id.FIXED_DICT:return e.reader.readStream;case e.datatype2id.ARRAY:return e.reader.readStream;default:return e.reader.readStream}}var a=function(){function t(){this.memorystreams=new Array,this.numMessage=0,this.messageLengthBuffer=null,this.msgtype=null,this.messageLength=0,this.stream=new e.MemoryStream(e.PACKET_MAX_SIZE_TCP)}return t.prototype.newMessage=function(t){this.fini(!1),this.msgtype=t,this.numMessage+=1,-1==this.msgtype.length&&(this.messageLengthBuffer=new Uint8Array(this.stream.buffer,this.stream.wpos+e.MESSAGE_ID_LENGTH,2)),this.writeUint16(t.id),this.messageLengthBuffer&&(this.writeUint16(0),this.messageLengthBuffer[0]=0,this.messageLengthBuffer[1]=0,this.messageLength=0)},t.prototype.writeMsgLength=function(e){this.messageLengthBuffer&&(this.messageLengthBuffer[0]=255&e,this.messageLengthBuffer[1]=e>>8&255)},t.prototype.fini=function(e){this.numMessage>0&&(this.writeMsgLength(this.messageLength),this.stream&&this.memorystreams.push(this.stream)),e&&(this.messageLengthBuffer=null,this.numMessage=0,this.msgtype=null)},t.prototype.send=function(t){this.fini(!0);for(var n=0;n<this.memorystreams.length;n++){var r=this.memorystreams[n];t.send(r.getbuffer())}this.memorystreams=new Array,this.stream=new e.MemoryStream(e.PACKET_MAX_SIZE_TCP)},t.prototype.checkStream=function(t){t>this.stream.space()&&(this.memorystreams.push(this.stream),this.stream=new e.MemoryStream(e.PACKET_MAX_SIZE_TCP)),this.messageLength+=t},t.prototype.writeInt8=function(e){this.checkStream(1),this.stream.writeInt8(e)},t.prototype.writeInt16=function(e){this.checkStream(2),this.stream.writeInt16(e)},t.prototype.writeInt32=function(e){this.checkStream(4),this.stream.writeInt32(e)},t.prototype.writeInt64=function(e){this.checkStream(8),this.stream.writeInt64(e)},t.prototype.writeUint8=function(e){this.checkStream(1),this.stream.writeUint8(e)},t.prototype.writeUint16=function(e){this.checkStream(2),this.stream.writeUint16(e)},t.prototype.writeUint32=function(e){this.checkStream(4),this.stream.writeUint32(e)},t.prototype.writeUint64=function(e){this.checkStream(8),this.stream.writeUint64(e)},t.prototype.writeFloat=function(e){this.checkStream(4),this.stream.writeFloat(e)},t.prototype.writeDouble=function(e){this.checkStream(8),this.stream.writeDouble(e)},t.prototype.writeString=function(e){this.checkStream(e.length+1),this.stream.writeString(e)},t.prototype.writeBlob=function(e){this.checkStream(e.length+4),this.stream.writeBlob(e)},t}();e.Bundle=a,__reflect(a.prototype,"KBEngine.Bundle"),e.reader=new e.MemoryStream(0),e.datatype2id={},e.mappingDataType=t,t(),e.bindWriter=n,e.bindReader=r;var i=function(){function t(e,t,n,a,i,o){this.id=e,this.name=t,this.length=n,this.argsType=a;for(var p=0;p<i.length;p++)i[p]=r(i[p]);this.args=i,this.handler=o}return t.prototype.createFromStream=function(e){if(this.args.length<=0)return e;for(var t=new Array(this.args.length),n=0;n<this.args.length;n++)t[n]=this.args[n].call(e);return t},t.prototype.handleMessage=function(t){return null==this.handler?void e.ERROR_MSG("Message::handleMessage: interface("+this.name+"/"+this.id+") no implement!"):void(this.args.length<=0?this.argsType<0?this.handler(t):this.handler():this.handler.apply(e.app,this.createFromStream(t)))},t}();e.Message=i,__reflect(i.prototype,"KBEngine.Message");var o;!function(e){e.loginapp={},e.baseapp={},e.Loginapp_importClientMessages=new i(5,"importClientMessages",0,0,new Array,null),e.Baseapp_importClientMessages=new i(207,"importClientMessages",0,0,new Array,null),e.Baseapp_importClientEntityDef=new i(208,"importClientEntityDef",0,0,new Array,null),e.onImportClientMessages=new i(518,"onImportClientMessages",-1,-1,new Array,null)}(o=e.messages||(e.messages={})),e.clientmessages={},e.bufferedCreateEntityMessage={}}(KBEngine||(KBEngine={})),function(e){function t(e,t,n){if(t>n){var r=t;t=n,n=r}return t>e?t:n>e?e:n}function n(e,t){return e*(Math.PI/(t?254:128))}function r(e,n){var r=0;return r=n?t(Math.floor(254*e/Math.PI+.5),-128,127):Math.floor(128*e/Math.PI+.5)}var a=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.distance=function(e){var t=e.x-this.x,n=e.y-this.y;return Math.sqrt(t*t+n*n)},e}();e.Vector2=a,__reflect(a.prototype,"KBEngine.Vector2");var i=function(){function e(e,t,n){this.x=e,this.y=t,this.z=n}return e.prototype.distance=function(e){var t=e.x-this.x,n=e.y-this.y,r=e.z-this.z;return Math.sqrt(t*t+n*n+r*r)},e}();e.Vector3=i,__reflect(i.prototype,"KBEngine.Vector3");var o=function(){function e(e,t,n,r){this.x=e,this.y=t,this.z=n,this.w=r}return e.prototype.distance=function(e){var t=e.x-this.x,n=e.y-this.y,r=e.z-this.z;return Math.sqrt(t*t+n*n+r*r)},e}();e.Vector4=o,__reflect(o.prototype,"KBEngine.Vector4"),e.clampf=t,e.int82angle=n,e.angle2int8=r}(KBEngine||(KBEngine={})),function(e){var t=function(){function t(){this.id=0,this.className="",this.position=new e.Vector3(0,0,0),this.direction=new e.Vector3(0,0,0),this.velocity=0,this.cell=null,this.base=null,this.inWorld=!1,this.inited=!1,this.isControlled=!1,this.entityLastLocalPos=new e.Vector3(0,0,0),this.entityLastLocalDir=new e.Vector3(0,0,0),this.isOnGround=!1}return t.prototype.__init__=function(){},t.prototype.callPropertysSetMethods=function(){var t=e.moduledefs[this.className];for(var n in t.propertys){var r=t.propertys[n];r[0];n=r[2];var a=r[5],i=r[6],o=this[n];if(null!=a)if(32==i||64==i)this.inited&&!this.inWorld&&a.call(this,o);else if(this.inWorld){if((8==i||16==i)&&!this.isPlayer())continue;a.call(this,o)}}},t.prototype.onDestroy=function(){},t.prototype.onControlled=function(e){},t.prototype.isPlayer=function(){return this.id==e.app.entity_id},t.prototype.baseCall=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(void 0==this.base)return void e.ERROR_MSG("Entity::baseCall: base is None!");var a=e.moduledefs[this.className].base_methods[t];if(void 0==a)return void e.ERROR_MSG("Entity::baseCall: The server did not find the def_method("+this.className+"."+t+")!");var i=a[0],o=a[3];if(n.length!=o.length)return void e.ERROR_MSG("Entity::baseCall: args("+(n.length-1)+"!= "+o.length+") size is error!");this.base.newCall(),this.base.bundle.writeUint16(i);try{for(var p=0;p<n.length;p++){if(!o[p].isSameType(n[p]))throw new Error("Entity::baseCall: arg["+p+"] is error!");o[p].addToStream(this.base.bundle,n[p])}}catch(s){return e.ERROR_MSG(s.toString()),e.ERROR_MSG("Entity::baseCall: args is error!"),void(this.base.bundle=null)}this.base.sendCall()},t.prototype.cellCall=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];if(void 0==this.cell)return void e.ERROR_MSG("Entity::cellCall: cell is None!");var a=e.moduledefs[this.className].cell_methods[t];if(void 0==a)return void e.ERROR_MSG("Entity::cellCall: The server did not find the def_method("+this.className+"."+t+")!");var i=a[0],o=a[3];if(n.length!=o.length)return void e.ERROR_MSG("Entity::cellCall: args("+n.length+"!= "+o.length+") size is error!");this.cell.newCall(),this.cell.bundle.writeUint16(i);try{for(var p=0;p<o.length;p++){if(!o[p].isSameType(n[p]))throw new Error("Entity::cellCall: arg["+p+"] is error!");o[p].addToStream(this.cell.bundle,n[p])}}catch(s){return e.ERROR_MSG(s.toString()),e.ERROR_MSG("Entity::cellCall: args is error!"),void(this.cell.bundle=null)}this.cell.sendCall()},t.prototype.enterWorld=function(){e.INFO_MSG(this.className+"::enterWorld: "+this.id),this.inWorld=!0,this.onEnterWorld(),e.Event.fire("onEnterWorld",this)},t.prototype.onEnterWorld=function(){},t.prototype.leaveWorld=function(){e.INFO_MSG(this.className+"::leaveWorld: "+this.id),this.inWorld=!1,this.onLeaveWorld(),e.Event.fire("onLeaveWorld",this)},t.prototype.onLeaveWorld=function(){},t.prototype.enterSpace=function(){e.INFO_MSG(this.className+"::enterSpace: "+this.id),this.onEnterSpace(),e.Event.fire("onEnterSpace",this),e.Event.fire("set_position",this),e.Event.fire("set_direction",this)},t.prototype.onEnterSpace=function(){},t.prototype.leaveSpace=function(){e.INFO_MSG(this.className+"::leaveSpace: "+this.id),this.onLeaveSpace(),e.Event.fire("onLeaveSpace",this)},t.prototype.onLeaveSpace=function(){},t.prototype.set_position=function(){this.isPlayer()&&(e.app.entityServerPos.x=this.position.x,e.app.entityServerPos.y=this.position.y,e.app.entityServerPos.z=this.position.z),e.Event.fire("set_position",this)},t.prototype.onUpdateVolatileData=function(){},t.prototype.set_direction=function(t){e.Event.fire("set_direction",this)},t}();e.Entity=t,__reflect(t.prototype,"KBEngine.Entity")}(KBEngine||(KBEngine={})),function(e){e.ENTITYCALL_TYPE_CELL=0,e.ENTITYCALL_TYPE_BASE=1;var t=function(){function t(){this.id=0,this.className="",this.type=e.ENTITYCALL_TYPE_CELL,this.networkInterface=e.app,this.bundle=null}return t.prototype.isBase=function(){return this.type==e.ENTITYCALL_TYPE_BASE},t.prototype.isCell=function(){return this.type==e.ENTITYCALL_TYPE_CELL},t.prototype.newCall=function(){return null==this.bundle&&(this.bundle=new e.Bundle),this.type==e.ENTITYCALL_TYPE_CELL?this.bundle.newMessage(e.messages.Baseapp_onRemoteCallCellMethodFromClient):this.bundle.newMessage(e.messages.Entity_onRemoteMethodCall),this.bundle.writeInt32(this.id),this.bundle},t.prototype.sendCall=function(e){void 0==e&&(e=this.bundle),e.send(this.networkInterface),this.bundle==e&&(this.bundle=null)},t}();e.EntityCall=t,__reflect(t.prototype,"KBEngine.EntityCall");var n=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readUint8.call(t)},t.prototype.addToStream=function(e,t){e.writeUint8(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>255?!1:!0},t}();e.DATATYPE_UINT8=n,__reflect(n.prototype,"KBEngine.DATATYPE_UINT8");var r=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readUint16.call(t)},t.prototype.addToStream=function(e,t){e.writeUint16(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>65535?!1:!0},t}();e.DATATYPE_UINT16=r,__reflect(r.prototype,"KBEngine.DATATYPE_UINT16");var a=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readUint32.call(t)},t.prototype.addToStream=function(e,t){e.writeUint32(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:0>e||e>4294967295?!1:!0},t}();e.DATATYPE_UINT32=a,__reflect(a.prototype,"KBEngine.DATATYPE_UINT32");var i=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readUint64.call(t)},t.prototype.addToStream=function(e,t){e.writeUint64(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(t){return t instanceof e.UINT64},t}();e.DATATYPE_UINT64=i,__reflect(i.prototype,"KBEngine.DATATYPE_UINT64");var o=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readInt8.call(t)},t.prototype.addToStream=function(e,t){e.writeInt8(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:-128>e||e>127?!1:!0},t}();e.DATATYPE_INT8=o,__reflect(o.prototype,"KBEngine.DATATYPE_INT8");var p=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readInt16.call(t)},t.prototype.addToStream=function(e,t){e.writeInt16(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:-32768>e||e>32767?!1:!0},t}();e.DATATYPE_INT16=p,__reflect(p.prototype,"KBEngine.DATATYPE_INT16");var s=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readInt32.call(t)},t.prototype.addToStream=function(e,t){e.writeInt32(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(e){return"number"!=typeof e?!1:-2147483648>e||e>2147483647?!1:!0},t}();e.DATATYPE_INT32=s,__reflect(s.prototype,"KBEngine.DATATYPE_INT32");var l=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readInt64.call(t)},t.prototype.addToStream=function(e,t){e.writeInt64(t)},t.prototype.parseDefaultValStr=function(e){return parseInt(e)},t.prototype.isSameType=function(t){return t instanceof e.INT64},t}();e.DATATYPE_INT64=l,__reflect(l.prototype,"KBEngine.DATATYPE_INT64");var c=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readFloat.call(t)},t.prototype.addToStream=function(e,t){e.writeFloat(t)},t.prototype.parseDefaultValStr=function(e){return parseFloat(e)},t.prototype.isSameType=function(e){return"number"==typeof e},t}();e.DATATYPE_FLOAT=c,__reflect(c.prototype,"KBEngine.DATATYPE_FLOAT");var d=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.createFromStream=function(t){return e.reader.readDouble.call(t)},n.prototype.addToStream=function(e,t){e.writeDouble(t)},n}(c);e.DATATYPE_DOUBLE=d,__reflect(d.prototype,"KBEngine.DATATYPE_DOUBLE");var u=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.reader.readString.call(t)},t.prototype.addToStream=function(e,t){e.writeString(t)},t.prototype.parseDefaultValStr=function(e){return"string"==typeof e?e:""},t.prototype.isSameType=function(e){return"string"==typeof e},t}();e.DATATYPE_STRING=u,__reflect(u.prototype,"KBEngine.DATATYPE_STRING");var y=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.CLIENT_NO_FLOAT?new e.Vector2(e.reader.readInt32.call(t),e.reader.readInt32.call(t)):new e.Vector2(e.reader.readFloat.call(t),e.reader.readFloat.call(t))},t.prototype.addToStream=function(t,n){e.CLIENT_NO_FLOAT?(t.writeInt32(n.x),t.writeInt32(n.y)):(t.writeFloat(n.x),t.writeFloat(n.y))},t.prototype.parseDefaultValStr=function(t){return new e.Vector2(0,0)},t.prototype.isSameType=function(t){return t instanceof e.Vector2?!0:!1},t}();e.DATATYPE_VECTOR2=y,__reflect(y.prototype,"KBEngine.DATATYPE_VECTOR2");var f=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.CLIENT_NO_FLOAT?new e.Vector3(e.reader.readInt32.call(t),e.reader.readInt32.call(t),e.reader.readInt32.call(t)):new e.Vector3(e.reader.readFloat.call(t),e.reader.readFloat.call(t),e.reader.readFloat.call(t))},t.prototype.addToStream=function(t,n){e.CLIENT_NO_FLOAT?(t.writeInt32(n.x),t.writeInt32(n.y),t.writeInt32(n.z)):(t.writeFloat(n.x),t.writeFloat(n.y),t.writeFloat(n.z))},t.prototype.parseDefaultValStr=function(t){return new e.Vector3(0,0,0)},t.prototype.isSameType=function(t){return t instanceof e.Vector3?!0:!1},t}();e.DATATYPE_VECTOR3=f,__reflect(f.prototype,"KBEngine.DATATYPE_VECTOR3");var _=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.CLIENT_NO_FLOAT?new e.Vector4(e.reader.readInt32.call(t),e.reader.readInt32.call(t),e.reader.readInt32.call(t),e.reader.readFloat.call(t)):new e.Vector4(e.reader.readFloat.call(t),e.reader.readFloat.call(t),e.reader.readFloat.call(t),e.reader.readFloat.call(t))},t.prototype.addToStream=function(t,n){e.CLIENT_NO_FLOAT?(t.writeInt32(n.x),t.writeInt32(n.y),t.writeInt32(n.z),t.writeInt32(n.w)):(t.writeFloat(n.x),t.writeFloat(n.y),t.writeFloat(n.z),t.writeFloat(n.w))},t.prototype.parseDefaultValStr=function(t){return new e.Vector4(0,0,0,0)},t.prototype.isSameType=function(t){return t instanceof e.Vector4?!0:!1},t}();e.DATATYPE_VECTOR4=_,__reflect(_.prototype,"KBEngine.DATATYPE_VECTOR4");var E=function(){function e(){}return e.prototype.bind=function(){},e.prototype.createFromStream=function(e){},e.prototype.addToStream=function(e,t){},e.prototype.parseDefaultValStr=function(e){return new Uint8Array(0)},e.prototype.isSameType=function(e){return!1},e}();e.DATATYPE_PYTHON=E,__reflect(E.prototype,"KBEngine.DATATYPE_PYTHON");var g=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){return e.utf8ArrayToString(e.reader.readBlob.call(t))},t.prototype.addToStream=function(t,n){t.writeBlob(e.stringToUTF8Bytes(n))},t.prototype.parseDefaultValStr=function(e){return"string"==typeof e?e:""},t.prototype.isSameType=function(e){return"string"==typeof e},t}();e.DATATYPE_UNICODE=g,__reflect(g.prototype,"KBEngine.DATATYPE_UNICODE");var h=function(){function e(){}return e.prototype.bind=function(){},e.prototype.createFromStream=function(e){},e.prototype.addToStream=function(e,t){},e.prototype.parseDefaultValStr=function(e){return new Uint8Array(0)},e.prototype.isSameType=function(e){return!1},e}();e.DATATYPE_ENTITYCALL=h,__reflect(h.prototype,"KBEngine.DATATYPE_ENTITYCALL");var m=function(){function t(){}return t.prototype.bind=function(){},t.prototype.createFromStream=function(t){var n=e.reader.readUint32.call(t),r=new Uint8Array(t.buffer,t.rpos,n);return t.rpos+=n,r},t.prototype.addToStream=function(e,t){e.writeBlob(t)},t.prototype.parseDefaultValStr=function(e){return new Uint8Array(0)},t.prototype.isSameType=function(e){return!0},t}();e.DATATYPE_BLOB=m,__reflect(m.prototype,"KBEngine.DATATYPE_BLOB");var v=function(){function e(){this.type=null}return e.prototype.bind=function(){"number"==typeof this.type&&(this.type=T[this.type])},e.prototype.createFromStream=function(e){for(var t=e.readUint32(),n=[];t>0;)t--,n.push(this.type.createFromStream(e));return n},e.prototype.addToStream=function(e,t){e.writeUint32(t.length);for(var n=0;n<t.length;n++)this.type.addToStream(e,t[n])},e.prototype.parseDefaultValStr=function(e){return[]},e.prototype.isSameType=function(e){for(var t=0;t<e.length;t++)if(!this.type.isSameType(e[t]))return!1;return!0},e}();e.DATATYPE_ARRAY=v,__reflect(v.prototype,"KBEngine.DATATYPE_ARRAY");var S=function(){function e(){this.dicttype={},this.implementedBy=null}return e.prototype.bind=function(){for(var e in this.dicttype){var t=this.dicttype[e];"number"==typeof this.dicttype[e]&&(this.dicttype[e]=T[t])}},e.prototype.createFromStream=function(e){var t={};for(var n in this.dicttype)t[n]=this.dicttype[n].createFromStream(e);return t},e.prototype.addToStream=function(e,t){for(var n in this.dicttype)this.dicttype[n].addToStream(e,t[n])},e.prototype.parseDefaultValStr=function(e){return{}},e.prototype.isSameType=function(e){for(var t in this.dicttype)if(!this.dicttype[t].isSameType(e[t]))return!1;return!0},e}();e.DATATYPE_FIXED_DICT=S,__reflect(S.prototype,"KBEngine.DATATYPE_FIXED_DICT");var T;!function(e){e.UINT8=new n,e.UINT16=new r,e.UINT32=new a,e.UINT64=new i,e.INT8=new o,e.INT16=new p,e.INT32=new s,e.INT64=new l,e.FLOAT=new c,e.DOUBLE=new d,e.STRING=new u,e.VECTOR2=new y,e.VECTOR3=new f,e.VECTOR4=new _,e.PYTHON=new E,e.UNICODE=new g,e.ENTITYCALL=new h,e.BLOB=new m}(T=e.datatypes||(e.datatypes={}))}(KBEngine||(KBEngine={})),function(e){var t=function(){function e(){this.ip="127.0.0.1",this.port=20013,this.updateHZ=100,this.serverHeartbeatTick=15,this.protocol="ws://",this.clientType=5,this.isOnInitCallPropertysSetMethods=!0}return e}();e.KBEngineArgs=t,__reflect(t.prototype,"KBEngine.KBEngineArgs")}(KBEngine||(KBEngine={})),function(e){function t(t){if(void 0==e.app){if(t.constructor!=e.KBEngineArgs)return void e.ERROR_MSG("create(): args("+t+") error! not is KBEngineArgs");new r(t),e.app.reset(),e.app.installEvents(),i=setInterval(e.app.update,t.updateHZ)}}function n(){void 0!=i&&clearInterval(i),void 0!=e.app&&(e.app.uninstallEvents(),e.app.reset(),e.app=void 0)}e.moduledefs={};var r=function(){function t(t){this.username="testhtml51",this.password="123456",this.clientdatas="",this.encryptedKey="",this.loginappMessageImported=!1,this.baseappMessageImported=!1,this.serverErrorsDescrImported=!1,this.entitydefImported=!1,this.serverErrs={},this.baseappIP="",this.baseappPort=0,this.currstate="create",this.serverdatas="",this.serverVersion="",this.serverScriptVersion="",this.serverProtocolMD5="",this.serverEntityDefMD5="",this.clientVersion="1.1.5",this.clientScriptVersion="0.1.0",this.entity_uuid=null,this.entity_id=0,this.entity_type="",this.entityServerPos=new e.Vector3(0,0,0),this.entities={},this.entityIDAliasIDList=[],this.controlledEntities=[],this.spacedata={},this.spaceID=0,this.spaceResPath="",this.isLoadedGeometry=!1,this.lastTickTime=Date.now(),this.lastTickCBTime=Date.now(),this.entityclass={},e.app=this,this.args=t}return t.prototype.resetSocket=function(){try{if(void 0!=e.app.socket&&null!=e.app.socket){var t=e.app.socket;t.onopen=void 0,t.onerror=void 0,t.onmessage=void 0,t.onclose=void 0,e.app.socket=null,t.close()}}catch(n){}},t.prototype.reset=function(){void 0!=e.app.entities&&null!=e.app.entities&&e.app.clearEntities(!0),e.app.resetSocket(),e.app.currserver="loginapp",e.app.currstate="create",e.app.serverdatas="",e.app.serverVersion="",e.app.serverScriptVersion="",e.app.serverProtocolMD5="",e.app.serverEntityDefMD5="",e.app.clientVersion="1.1.5",e.app.clientScriptVersion="0.1.0",e.app.entity_uuid=null,e.app.entity_id=0,e.app.entity_type="",e.app.entityServerPos=new e.Vector3(0,0,0),e.app.entities={},e.app.entityIDAliasIDList=[],e.app.controlledEntities=[],e.app.spacedata={},e.app.spaceID=0,e.app.spaceResPath="",e.app.isLoadedGeometry=!1;
var t=new Date;e.app.lastTickTime=t.getTime(),e.app.lastTickCBTime=t.getTime(),e.mappingDataType(),e.app.component="client"},t.prototype.installEvents=function(){e.Event.register("createAccount",e.app,"createAccount"),e.Event.register("login",e.app,"login"),e.Event.register("reloginBaseapp",e.app,"reloginBaseapp"),e.Event.register("bindAccountEmail",e.app,"bindAccountEmail"),e.Event.register("newPassword",e.app,"newPassword")},t.prototype.uninstallEvents=function(){e.Event.deregister("reloginBaseapp",e.app),e.Event.deregister("login",e.app),e.Event.deregister("createAccount",e.app)},t.prototype.hello=function(){var t=new e.Bundle;"loginapp"==e.app.currserver?t.newMessage(e.messages.Loginapp_hello):t.newMessage(e.messages.Baseapp_hello),t.writeString(e.app.clientVersion),t.writeString(e.app.clientScriptVersion),t.writeBlob(e.app.encryptedKey),t.send(e.app)},t.prototype.player=function(){return e.app.entities[e.app.entity_id]},t.prototype.findEntity=function(t){return e.app.entities[t]},t.prototype.connect=function(t,n){try{var r=e.app.args.protocol+t+":"+n;e.app.socket=new WebSocket(r)}catch(a){return e.ERROR_MSG("WebSocket init error!"),void e.Event.fire("onConnectionState",!1)}e.app.socket.binaryType="arraybuffer",e.app.socket.onopen=e.app.onopen,e.app.socket.onerror=e.app.onerror_before_onopen,e.app.socket.onmessage=e.app.onmessage,e.app.socket.onclose=e.app.onclose},t.prototype.disconnect=function(){e.app.resetSocket()},t.prototype.onopen=function(){e.INFO_MSG("connect success!"),e.app.socket.onerror=e.app.onerror_after_onopen,e.Event.fire("onConnectionState",!0)},t.prototype.onerror_before_onopen=function(t){e.ERROR_MSG("connect error:"+t.data),e.app.resetSocket(),e.Event.fire("onConnectionState",!1)},t.prototype.onerror_after_onopen=function(t){e.ERROR_MSG("connect error:"+t.data),e.app.resetSocket(),e.Event.fire("onDisconnected")},t.prototype.onmessage=function(t){var n=new e.MemoryStream(t.data);for(n.wpos=t.data.byteLength;n.rpos<n.wpos;){var r=n.readUint16(),a=e.clientmessages[r];if(a){var i=a.length;-1==i&&(i=n.readUint16(),65535==i&&(i=n.readUint32()));var o=n.wpos,p=n.rpos+i;n.wpos=p,a.handleMessage(n),n.wpos=o,n.rpos=p}else e.ERROR_MSG("KBEngineApp::onmessage["+e.app.currserver+"]: not found msg("+r+")!")}},t.prototype.onclose=function(){e.INFO_MSG("connect close:"+e.app.currserver),e.app.resetSocket(),e.Event.fire("onDisconnected")},t.prototype.send=function(t){e.app.socket.send(t)},t.prototype.close=function(){e.INFO_MSG("KBEngine::close()"),e.app.socket.close(),e.app.reset()},t.prototype.update=function(){if(null!=e.app.socket){var t=new Date;if((t.getTime()-e.app.lastTickTime)/1e3>e.app.args.serverHeartbeatTick){if(e.app.lastTickCBTime<e.app.lastTickTime&&(e.ERROR_MSG("sendTick: Receive appTick timeout!"),e.app.socket.close()),"loginapp"==e.app.currserver){if(void 0!=e.messages.Loginapp_onClientActiveTick){var n=new e.Bundle;n.newMessage(e.messages.Loginapp_onClientActiveTick),n.send(e.app)}}else if(void 0!=e.messages.Baseapp_onClientActiveTick){var n=new e.Bundle;n.newMessage(e.messages.Baseapp_onClientActiveTick),n.send(e.app)}e.app.lastTickTime=t.getTime()}e.app.updatePlayerToServer()}},t.prototype.Client_onAppActiveTickCB=function(){var t=new Date;e.app.lastTickCBTime=t.getTime()},t.prototype.serverErr=function(t){var n=e.app.serverErrs[t];return void 0==n?"":n.name+" ["+n.descr+"]"},t.prototype.Client_onImportServerErrorsDescr=function(t){for(var n=t.readUint16();n>0;){n-=1;var r=new a;r.id=t.readUint16(),r.name=e.utf8ArrayToString(t.readBlob()),r.descr=e.utf8ArrayToString(t.readBlob()),e.app.serverErrs[r.id]=r,e.INFO_MSG("Client_onImportServerErrorsDescr: id="+r.id+", name="+r.name+", descr="+r.descr)}},t.prototype.onOpenLoginapp_login=function(){if(e.INFO_MSG("KBEngineApp::onOpenLoginapp_login: successfully!"),e.Event.fire("onConnectionState",!0),e.app.currserver="loginapp",e.app.currstate="login",e.app.loginappMessageImported)e.app.onImportClientMessagesCompleted();else{var t=new e.Bundle;t.newMessage(e.messages.Loginapp_importClientMessages),t.send(e.app),e.app.socket.onmessage=e.app.Client_onImportClientMessages,e.INFO_MSG("KBEngineApp::onOpenLoginapp_login: start importClientMessages ..."),e.Event.fire("Loginapp_importClientMessages")}},t.prototype.onOpenLoginapp_createAccount=function(){if(e.Event.fire("onConnectionState",!0),e.INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: successfully!"),e.app.currserver="loginapp",e.app.currstate="createAccount",e.app.loginappMessageImported)e.app.onImportClientMessagesCompleted();else{var t=new e.Bundle;t.newMessage(e.messages.Loginapp_importClientMessages),t.send(e.app),e.app.socket.onmessage=e.app.Client_onImportClientMessages,e.INFO_MSG("KBEngineApp::onOpenLoginapp_createAccount: start importClientMessages ..."),e.Event.fire("Loginapp_importClientMessages")}},t.prototype.onImportClientMessagesCompleted=function(){if(e.INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: successfully!"),e.app.socket.onmessage=e.app.onmessage,e.app.hello(),"loginapp"==e.app.currserver){if(!e.app.serverErrorsDescrImported){e.INFO_MSG("KBEngine::onImportClientMessagesCompleted(): send importServerErrorsDescr!"),e.app.serverErrorsDescrImported=!0;var t=new e.Bundle;t.newMessage(e.messages.Loginapp_importServerErrorsDescr),t.send(e.app)}"login"==e.app.currstate?e.app.login_loginapp(!1):"resetpassword"==e.app.currstate?e.app.resetpassword_loginapp(!1):e.app.createAccount_loginapp(!1),e.app.loginappMessageImported=!0}else if(e.app.baseappMessageImported=!0,e.app.entitydefImported)e.app.onImportEntityDefCompleted();else{e.INFO_MSG("KBEngineApp::onImportClientMessagesCompleted: start importEntityDef ...");var t=new e.Bundle;t.newMessage(e.messages.Baseapp_importClientEntityDef),t.send(e.app),e.Event.fire("Baseapp_importClientEntityDef")}},t.prototype.createDataTypeFromStreams=function(t,n){var r=t.readUint16();for(e.INFO_MSG("KBEngineApp::createDataTypeFromStreams: importAlias(size="+r+")!");r>0;)r--,e.app.createDataTypeFromStream(t,n);for(var a in e.datatypes)void 0!=e.datatypes[a]&&e.datatypes[a].bind()},t.prototype.createDataTypeFromStream=function(t,n){var r,a=t.readUint16(),i=t.readString(),o=t.readString();if(0==o.length&&(r="Null_"+a),n&&e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: importAlias("+i+":"+o+")!"),"FIXED_DICT"==i){var p=new e.DATATYPE_FIXED_DICT,s=t.readUint8();for(p.implementedBy=t.readString();s>0;){s--;var l=t.readString(),c=t.readUint16();p.dicttype[l]=c}e.datatypes[o]=p}else if("ARRAY"==i){var d=t.readUint16(),p=new e.DATATYPE_ARRAY;p.type=d,e.datatypes[o]=p}else e.datatypes[o]=e.datatypes[i];e.datatypes[a]=e.datatypes[o],e.datatype2id[o]=a},t.prototype.Client_onImportClientEntityDef=function(t){for(e.app.createDataTypeFromStreams(t,!0);!t.readEOF();){var n=t.readString(),r=t.readUint16(),a=t.readUint16(),i=t.readUint16(),o=t.readUint16(),p=t.readUint16();e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: import("+n+"), propertys("+a+"), clientMethods("+i+"), baseMethods("+o+"), cellMethods("+p+")!"),e.moduledefs[n]={};var s=e.moduledefs[n];s.name=n,s.propertys={},s.methods={},s.base_methods={},s.cell_methods={},e.moduledefs[r]=s;var l=s.propertys,c=s.methods,d=s.base_methods,u=s.cell_methods;try{var y=e.Entities[n]}catch(f){}for(;a>0;){a--;var _=t.readUint16(),E=t.readUint32(),g=t.readInt16(),h=t.readString(),m=t.readString(),v=e.datatypes[t.readUint16()],S=null;void 0!=y&&(S=y.prototype["set_"+h],void 0==S&&(S=null));var T=[_,g,h,m,v,S,E];l[h]=T,-1!=g?(l[g]=T,s.usePropertyDescrAlias=!0):(l[_]=T,s.usePropertyDescrAlias=!1),e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+n+"), property("+h+"/"+_+").")}for(;i>0;){i--;for(var I=t.readUint16(),g=t.readInt16(),w=t.readString(),A=t.readUint8(),C=[];A>0;)A--,C.push(e.datatypes[t.readUint16()]);var T=[I,g,w,C];c[w]=T,-1!=g?(c[g]=T,s.useMethodDescrAlias=!0):(c[I]=T,s.useMethodDescrAlias=!1),e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+n+"), method("+w+").")}for(;o>0;){o--;for(var I=t.readUint16(),g=t.readInt16(),B=t.readString(),A=t.readUint8(),C=[];A>0;)A--,C.push(e.datatypes[t.readUint16()]);d[B]=[I,g,B,C],e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+n+"), base_method("+B+").")}for(;p>0;){p--;for(var I=t.readUint16(),g=t.readInt16(),D=t.readString(),A=t.readUint8(),C=[];A>0;)A--,C.push(e.datatypes[t.readUint16()]);u[D]=[I,g,D,C],e.INFO_MSG("KBEngineApp::Client_onImportClientEntityDef: add("+n+"), cell_method("+D+").")}var M=void 0;try{M=e.Entities[n]}catch(f){e.ERROR_MSG("KBEngineApp::Client_onImportClientEntityDef: module("+n+") not found!"),M=void 0}for(var L in s.propertys){var F=s.propertys[L],_=F[0],g=F[1],R=F[2],m=F[3],v=F[4];void 0!=M&&(M.prototype[R]=v.parseDefaultValStr(m))}for(var K in s.methods){var F=s.methods[K],_=F[0],g=F[1],R=F[2],C=F[3];void 0!=M&&void 0==M.prototype[R]&&e.WARNING_MSG(n+":: method("+R+") no implement!")}}e.app.onImportEntityDefCompleted()},t.prototype.Client_onVersionNotMatch=function(t){e.app.serverVersion=t.readString(),e.ERROR_MSG("Client_onVersionNotMatch: verInfo="+e.app.clientVersion+" not match(server: "+e.app.serverVersion+")"),e.Event.fire("onVersionNotMatch",e.app.clientVersion,e.app.serverVersion)},t.prototype.Client_onScriptVersionNotMatch=function(t){e.app.serverScriptVersion=t.readString(),e.ERROR_MSG("Client_onScriptVersionNotMatch: verInfo="+e.app.clientScriptVersion+" not match(server: "+e.app.serverScriptVersion+")"),e.Event.fire("onScriptVersionNotMatch",e.app.clientScriptVersion,e.app.serverScriptVersion)},t.prototype.onImportEntityDefCompleted=function(){e.INFO_MSG("KBEngineApp::onImportEntityDefCompleted: successfully!"),e.app.entitydefImported=!0,e.app.login_baseapp(!1)},t.prototype.Client_onImportClientMessages=function(t){var n=new e.MemoryStream(t.data),r=n.readUint16();if(r==e.messages.onImportClientMessages.id){var a=n.readUint16(),i=n.readUint16();for(e.INFO_MSG("KBEngineApp::onImportClientMessages: start("+i+") ...!");i>0;){i--,r=n.readUint16(),a=n.readInt16();for(var o=n.readString(),p=n.readInt8(),s=n.readUint8(),l=new Array(s),c=0;s>c;c++)l[c]=n.readUint8();var d=null,u=o.indexOf("Client_")>=0;u&&(d=e.app[o],null==d||void 0==d?(e.WARNING_MSG("KBEngineApp::onImportClientMessages["+e.app.currserver+"]: interface("+o+"/"+r+") no implement!"),d=null):e.INFO_MSG("KBEngineApp::onImportClientMessages: import("+o+") successfully!")),o.length>0?(e.messages[o]=new e.Message(r,o,a,p,l,d),u?e.clientmessages[r]=e.messages[o]:e.messages[e.app.currserver][r]=e.messages[o]):e.messages[e.app.currserver][r]=new e.Message(r,o,a,p,l,d)}e.app.onImportClientMessagesCompleted()}else e.ERROR_MSG("KBEngineApp::onmessage: not found msg("+r+")!")},t.prototype.createAccount=function(t,n,r){e.app.reset(),e.app.username=t,e.app.password=n,e.app.clientdatas=r,e.app.createAccount_loginapp(!0)},t.prototype.createAccount_loginapp=function(t){if(t)e.INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+e.app.args.ip+":"+e.app.args.port+"!"),e.app.connect(e.app.args.ip,e.app.args.port),e.app.socket.onopen=e.app.onOpenLoginapp_createAccount;else{var n=new e.Bundle;n.newMessage(e.messages.Loginapp_reqCreateAccount),n.writeString(e.app.username),n.writeString(e.app.password),n.writeBlob(e.app.clientdatas),n.send(e.app)}},t.prototype.bindAccountEmail=function(t){var n=new e.Bundle;n.newMessage(e.messages.Baseapp_reqAccountBindEmail),n.writeInt32(e.app.entity_id),n.writeString(e.app.password),n.writeString(t),n.send(e.app)},t.prototype.newPassword=function(t,n){var r=new e.Bundle;r.newMessage(e.messages.Baseapp_reqAccountNewPassword),r.writeInt32(e.app.entity_id),r.writeString(t),r.writeString(n),r.send(e.app)},t.prototype.login=function(t,n,r){e.app.reset(),e.app.username=t,e.app.password=n,e.app.clientdatas=r,e.app.login_loginapp(!0)},t.prototype.login_loginapp=function(t){if(t)e.INFO_MSG("KBEngineApp::login_loginapp: start connect to ws://"+e.app.args.ip+":"+e.app.args.port+"!"),e.app.connect(e.app.args.ip,e.app.args.port),e.app.socket.onopen=e.app.onOpenLoginapp_login;else{var n=new e.Bundle;n.newMessage(e.messages.Loginapp_login),n.writeInt8(e.app.args.clientType),n.writeBlob(e.app.clientdatas),n.writeString(e.app.username),n.writeString(e.app.password),n.send(e.app)}},t.prototype.onOpenLoginapp_resetpassword=function(){if(e.INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: successfully!"),e.app.currserver="loginapp",e.app.currstate="resetpassword",e.app.loginappMessageImported)e.app.onImportClientMessagesCompleted();else{var t=new e.Bundle;t.newMessage(e.messages.Loginapp_importClientMessages),t.send(e.app),e.app.socket.onmessage=e.app.Client_onImportClientMessages,e.INFO_MSG("KBEngineApp::onOpenLoginapp_resetpassword: start importClientMessages ...")}},t.prototype.reset_password=function(t){e.app.reset(),e.app.username=t,e.app.resetpassword_loginapp(!0)},t.prototype.resetpassword_loginapp=function(t){if(t)e.INFO_MSG("KBEngineApp::createAccount_loginapp: start connect to ws://"+e.app.args.ip+":"+e.app.args.port+"!"),e.app.connect(e.app.args.ip,e.app.args.port),e.app.socket.onopen=e.app.onOpenLoginapp_resetpassword;else{var n=new e.Bundle;n.newMessage(e.messages.Loginapp_reqAccountResetPassword),n.writeString(e.app.username),n.send(e.app)}},t.prototype.onOpenBaseapp=function(){if(e.INFO_MSG("KBEngineApp::onOpenBaseapp: successfully!"),e.app.currserver="baseapp",e.app.baseappMessageImported)e.app.onImportClientMessagesCompleted();else{var t=new e.Bundle;t.newMessage(e.messages.Baseapp_importClientMessages),t.send(e.app),e.app.socket.onmessage=e.app.Client_onImportClientMessages,e.Event.fire("Baseapp_importClientMessages")}},t.prototype.login_baseapp=function(t){if(t)e.Event.fire("onLoginBaseapp"),e.INFO_MSG("KBEngineApp::login_baseapp: start connect to ws://"+e.app.baseappIp+":"+e.app.baseappPort+"!"),e.app.connect(e.app.baseappIp,e.app.baseappPort),void 0!=e.app.socket&&null!=e.app.socket&&(e.app.socket.onopen=e.app.onOpenBaseapp);else{var n=new e.Bundle;n.newMessage(e.messages.Baseapp_loginBaseapp),n.writeString(e.app.username),n.writeString(e.app.password),n.send(e.app)}},t.prototype.reloginBaseapp=function(){(void 0==e.app.socket||null==e.app.socket)&&(e.app.resetSocket(),e.Event.fire("onReloginBaseapp"),e.INFO_MSG("KBEngineApp::reloginBaseapp: start connect to ws://"+e.app.baseappIp+":"+e.app.baseappPort+"!"),e.app.connect(e.app.baseappIp,e.app.baseappPort),void 0!=e.app.socket&&null!=e.app.socket&&(e.app.socket.onopen=e.app.onReOpenBaseapp))},t.prototype.onReOpenBaseapp=function(){e.INFO_MSG("KBEngineApp::onReOpenBaseapp: successfully!"),e.app.currserver="baseapp";var t=new e.Bundle;t.newMessage(e.messages.Baseapp_reloginBaseapp),t.writeString(e.app.username),t.writeString(e.app.password),t.writeUint64(e.app.entity_uuid),t.writeInt32(e.app.entity_id),t.send(e.app);var n=new Date;e.app.lastTickCBTime=n.getTime()},t.prototype.Client_onHelloCB=function(t){e.app.serverVersion=t.readString(),e.app.serverScriptVersion=t.readString(),e.app.serverProtocolMD5=t.readString(),e.app.serverEntityDefMD5=t.readString();var n=t.readInt32();e.INFO_MSG("KBEngineApp::Client_onHelloCB: verInfo("+e.app.serverVersion+"), scriptVerInfo("+e.app.serverScriptVersion+"), serverProtocolMD5("+e.app.serverProtocolMD5+"), serverEntityDefMD5("+e.app.serverEntityDefMD5+"), ctype("+n+")!");var r=new Date;e.app.lastTickCBTime=r.getTime()},t.prototype.Client_onLoginFailed=function(t){var n=t.readUint16();e.app.serverdatas=t.readBlob(),e.ERROR_MSG("KBEngineApp::Client_onLoginFailed: failedcode("+e.app.serverErrs[n].name+"), datas("+e.app.serverdatas.length+")!"),e.Event.fire("onLoginFailed",n)},t.prototype.Client_onLoginSuccessfully=function(t){var n=t.readString();e.app.username=n,e.app.baseappIp=t.readString(),e.app.baseappPort=t.readUint16(),e.app.serverdatas=t.readBlob(),e.INFO_MSG("KBEngineApp::Client_onLoginSuccessfully: accountName("+n+"), addr("+e.app.baseappIp+":"+e.app.baseappPort+"), datas("+e.app.serverdatas.length+")!"),e.app.disconnect(),e.app.login_baseapp(!0)},t.prototype.Client_onLoginBaseappFailed=function(t){e.ERROR_MSG("KBEngineApp::Client_onLoginBaseappFailed: failedcode("+e.app.serverErrs[t].name+")!"),e.Event.fire("onLoginBaseappFailed",t)},t.prototype.Client_onReloginBaseappFailed=function(t){e.ERROR_MSG("KBEngineApp::Client_onReloginBaseappFailed: failedcode("+e.app.serverErrs[t].name+")!"),e.Event.fire("onReloginBaseappFailed",t)},t.prototype.Client_onReloginBaseappSuccessfully=function(t){e.app.entity_uuid=t.readUint64(),e.DEBUG_MSG("KBEngineApp::Client_onReloginBaseappSuccessfully: "+e.app.username),e.Event.fire("onReloginBaseappSuccessfully")},t.prototype.getentityclass=function(t){var n=e.Entities[t];return void 0==n?(e.ERROR_MSG("KBEngineApp::getentityclass: entityType("+t+") is error!"),n):n},t.prototype.Client_onCreatedProxies=function(t,n,r){e.INFO_MSG("KBEngineApp::Client_onCreatedProxies: eid("+n+"), entityType("+r+")!");var a=e.app.entities[n];if(e.app.entity_uuid=t,e.app.entity_id=n,void 0==a){var i=e.app.getentityclass(r);if(void 0==i)return;var o=new i;o.id=n,o.className=r,o.base=new e.EntityCall,o.base.id=n,o.base.className=r,o.base.type=e.ENTITYCALL_TYPE_BASE,e.app.entities[n]=o;var p=e.bufferedCreateEntityMessage[n];void 0!=p&&(e.app.Client_onUpdatePropertys(p),delete e.bufferedCreateEntityMessage[n]),o.__init__(),o.inited=!0,e.app.args.isOnInitCallPropertysSetMethods&&o.callPropertysSetMethods()}else{var p=e.bufferedCreateEntityMessage[n];void 0!=p&&(e.app.Client_onUpdatePropertys(p),delete e.bufferedCreateEntityMessage[n])}},t.prototype.getViewEntityIDFromStream=function(t){var n=0;if(e.app.entityIDAliasIDList.length>255)n=t.readInt32();else{var r=t.readUint8();if(e.app.entityIDAliasIDList.length<=r)return 0;n=e.app.entityIDAliasIDList[r]}return n},t.prototype.onUpdatePropertys_=function(t,n){var r=e.app.entities[t];if(void 0==r){var a=e.bufferedCreateEntityMessage[t];if(void 0!=a)return void e.ERROR_MSG("KBEngineApp::Client_onUpdatePropertys: entity("+t+") not found!");var i=new e.MemoryStream(n.buffer);return i.wpos=n.wpos,i.rpos=n.rpos-4,void(e.bufferedCreateEntityMessage[t]=i)}for(var o=e.moduledefs[r.className],p=o.propertys;n.length()>0;){var s=0;s=o.usePropertyDescrAlias?n.readUint8():n.readUint16();var l=p[s],c=l[5],d=l[6],u=l[4].createFromStream(n),y=r[l[2]];e.INFO_MSG("KBEngineApp::Client_onUpdatePropertys: "+r.className+"(id="+t+" "+l[2]+", val="+u+")!"),r[l[2]]=u,null!=c&&(32==d||64==d?r.inited&&c.call(r,y):r.inWorld&&c.call(r,y))}},t.prototype.Client_onUpdatePropertysOptimized=function(t){var n=e.app.getViewEntityIDFromStream(t);e.app.onUpdatePropertys_(n,t)},t.prototype.Client_onUpdatePropertys=function(t){var n=t.readInt32();e.app.onUpdatePropertys_(n,t)},t.prototype.onRemoteMethodCall_=function(t,n){var r=e.app.entities[t];if(void 0==r)return void e.ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+t+") not found!");var a=0;a=e.moduledefs[r.className].useMethodDescrAlias?n.readUint8():n.readUint16();for(var i=e.moduledefs[r.className].methods[a],o=[],p=i[3],s=0;s<p.length;s++)o.push(p[s].createFromStream(n));void 0!=r[i[2]]?r[i[2]].apply(r,o):e.ERROR_MSG("KBEngineApp::Client_onRemoteMethodCall: entity("+t+") not found method("+i[2]+")!")},t.prototype.Client_onRemoteMethodCallOptimized=function(t){var n=e.app.getViewEntityIDFromStream(t);e.app.onRemoteMethodCall_(n,t)},t.prototype.Client_onRemoteMethodCall=function(t){var n=t.readInt32();e.app.onRemoteMethodCall_(n,t)},t.prototype.Client_onEntityEnterWorld=function(t){var n=t.readInt32();e.app.entity_id>0&&n!=e.app.entity_id&&e.app.entityIDAliasIDList.push(n);var r;r=e.moduledefs.Length>255?t.readUint16():t.readUint8();var a=!0;t.length()>0&&(a=t.readInt8()),r=e.moduledefs[r].name,e.INFO_MSG("KBEngineApp::Client_onEntityEnterWorld: "+r+"("+n+"), spaceID("+e.app.spaceID+"), isOnGround("+a+")!");var i=e.app.entities[n];if(void 0==i){var o=e.bufferedCreateEntityMessage[n];if(void 0==o)return void e.ERROR_MSG("KBEngineApp::Client_onEntityEnterWorld: entity("+n+") not found!");var p=e.app.getentityclass(r);if(void 0==p)return;var s=new p;s.id=n,s.className=r,s.cell=new e.EntityCall,s.cell.id=n,s.cell.className=r,s.cell.type=e.ENTITYCALL_TYPE_CELL,e.app.entities[n]=s,e.app.Client_onUpdatePropertys(o),delete e.bufferedCreateEntityMessage[n],s.isOnGround=a,s.__init__(),s.inited=!0,s.inWorld=!0,s.enterWorld(),e.app.args.isOnInitCallPropertysSetMethods&&s.callPropertysSetMethods(),s.set_direction(s.direction),s.set_position(s.position)}else i.inWorld||(i.cell=new e.EntityCall,i.cell.id=n,i.cell.className=r,i.cell.type=e.ENTITYCALL_TYPE_CELL,e.app.entityIDAliasIDList=[],e.app.entities={},e.app.entities[i.id]=i,i.set_direction(i.direction),i.set_position(i.position),e.app.entityServerPos.x=i.position.x,e.app.entityServerPos.y=i.position.y,e.app.entityServerPos.z=i.position.z,i.isOnGround=a,i.inWorld=!0,i.enterWorld(),e.app.args.isOnInitCallPropertysSetMethods&&i.callPropertysSetMethods())},t.prototype.Client_onEntityLeaveWorldOptimized=function(t){var n=e.app.getViewEntityIDFromStream(t);e.app.Client_onEntityLeaveWorld(n)},t.prototype.Client_onEntityLeaveWorld=function(t){var n=e.app.entities[t];if(void 0==n)return void e.ERROR_MSG("KBEngineApp::Client_onEntityLeaveWorld: entity("+t+") not found!");if(n.inWorld&&n.leaveWorld(),e.app.entity_id>0&&t!=e.app.entity_id){for(var r=[],a=0;a<e.app.controlledEntities.length;a++)e.app.controlledEntities[a]!=t?r.push(e.app.controlledEntities[a]):e.Event.fire("onLoseControlledEntity");e.app.controlledEntities=r,delete e.app.entities[t];for(var i=[],a=0;a<e.app.entityIDAliasIDList.length;a++)e.app.entityIDAliasIDList[a]!=t&&i.push(e.app.entityIDAliasIDList[a]);e.app.entityIDAliasIDList=i}else e.app.clearSpace(!1),n.cell=null},t.prototype.Client_onEntityDestroyed=function(t){e.INFO_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+t+")!");var n=e.app.entities[t];return void 0==n?void e.ERROR_MSG("KBEngineApp::Client_onEntityDestroyed: entity("+t+") not found!"):(n.inWorld&&(e.app.entity_id==t&&e.app.clearSpace(!1),n.leaveWorld()),void delete e.app.entities[t])},t.prototype.Client_onEntityEnterSpace=function(t){var n=t.readInt32();e.app.spaceID=t.readUint32();var r=!0;t.length()>0&&(r=t.readInt8());var a=e.app.entities[n];return void 0==a?void e.ERROR_MSG("KBEngineApp::Client_onEntityEnterSpace: entity("+n+") not found!"):(a.isOnGround=r,e.app.entityServerPos.x=a.position.x,e.app.entityServerPos.y=a.position.y,e.app.entityServerPos.z=a.position.z,void a.enterSpace())},t.prototype.Client_onEntityLeaveSpace=function(t){var n=e.app.entities[t];return void 0==n?void e.ERROR_MSG("KBEngineApp::Client_onEntityLeaveSpace: entity("+t+") not found!"):(e.app.clearSpace(!1),void n.leaveSpace())},t.prototype.Client_onKicked=function(t){e.ERROR_MSG("KBEngineApp::Client_onKicked: failedcode("+e.app.serverErrs[t].name+")!"),e.Event.fire("onKicked",t)},t.prototype.Client_onCreateAccountResult=function(t){var n=t.readUint16(),r=t.readBlob();return e.Event.fire("onCreateAccountResult",n,r),0!=n?void e.ERROR_MSG("KBEngineApp::Client_onCreateAccountResult: "+e.app.username+" create is failed! code="+e.app.serverErrs[n].name+"!"):void e.INFO_MSG("KBEngineApp::Client_onCreateAccountResult: "+e.app.username+" create is successfully!")},t.prototype.Client_onControlEntity=function(t,n){var r=e.app.entities[t];if(void 0==r)return void e.ERROR_MSG("KBEngineApp::Client_onControlEntity: entity("+t+") not found!");var a=0!=n;if(a)e.app.player().id!=r.id&&e.app.controlledEntities.push(r);else{for(var i=[],o=0;o<e.app.controlledEntities.length;o++)e.app.controlledEntities[o]!=r.id&&i.push(e.app.controlledEntities[o]);e.app.controlledEntities=i}r.isControlled=a;try{r.onControlled(a),e.Event.fire("onControlled",r,a)}catch(p){e.ERROR_MSG("KBEngine::Client_onControlEntity: entity id = '"+t+"', is controlled = '"+a+"', error = '"+p+"'")}},t.prototype.updatePlayerToServer=function(){var t=e.app.player();if(void 0!=t&&0!=t.inWorld&&0!=e.app.spaceID&&!t.isControlled){if(t.entityLastLocalPos.distance(t.position)>.001||t.entityLastLocalDir.distance(t.direction)>.001){t.entityLastLocalPos.x=t.position.x,t.entityLastLocalPos.y=t.position.y,t.entityLastLocalPos.z=t.position.z,t.entityLastLocalDir.x=t.direction.x,t.entityLastLocalDir.y=t.direction.y,t.entityLastLocalDir.z=t.direction.z;var n=new e.Bundle;n.newMessage(e.messages.Baseapp_onUpdateDataFromClient),n.writeFloat(t.position.x),n.writeFloat(t.position.y),n.writeFloat(t.position.z),n.writeFloat(t.direction.x),n.writeFloat(t.direction.y),n.writeFloat(t.direction.z),n.writeUint8(t.isOnGround),n.writeUint32(e.app.spaceID),n.send(e.app)}for(var r in e.app.controlledEntities){var a=e.app.controlledEntities[r],i=a.position,o=a.direction,p=a.entityLastLocalPos.distance(i)>.001,s=a.entityLastLocalDir.distance(o)>.001;if(p||s){a.entityLastLocalPos=i,a.entityLastLocalDir=o;var n=new e.Bundle;n.newMessage(e.messages.Baseapp_onUpdateDataFromClientForControlledEntity),n.writeInt32(a.id),n.writeFloat(i.x),n.writeFloat(i.y),n.writeFloat(i.z),n.writeFloat(o.x),n.writeFloat(o.y),n.writeFloat(o.z),n.writeUint8(a.isOnGround),n.writeUint32(e.app.spaceID),n.send(e.app)}}}},t.prototype.addSpaceGeometryMapping=function(t,n){e.INFO_MSG("KBEngineApp::addSpaceGeometryMapping: spaceID("+t+"), respath("+n+")!"),e.app.spaceID=t,e.app.spaceResPath=n,e.Event.fire("addSpaceGeometryMapping",n)},t.prototype.clearSpace=function(t){e.app.entityIDAliasIDList=[],e.app.spacedata={},e.app.clearEntities(t),e.app.isLoadedGeometry=!1,e.app.spaceID=0},t.prototype.clearEntities=function(t){if(e.app.controlledEntities=[],t){for(var n in e.app.entities)e.app.entities[n].inWorld&&e.app.entities[n].leaveWorld(),e.app.entities[n].onDestroy();e.app.entities={}}else{var r=e.app.player();for(var n in e.app.entities)n!=r.id&&(e.app.entities[n].inWorld&&e.app.entities[n].leaveWorld(),e.app.entities[n].onDestroy());e.app.entities={},e.app.entities[r.id]=r}},t.prototype.Client_initSpaceData=function(t){for(e.app.clearSpace(!1),e.app.spaceID=t.readInt32();t.length()>0;){var n=t.readString(),r=t.readString();e.app.Client_setSpaceData(e.app.spaceID,n,r)}e.INFO_MSG("KBEngineApp::Client_initSpaceData: spaceID("+e.app.spaceID+"), datas("+e.app.spacedata+")!")},t.prototype.Client_setSpaceData=function(t,n,r){e.INFO_MSG("KBEngineApp::Client_setSpaceData: spaceID("+t+"), key("+n+"), value("+r+")!"),e.app.spacedata[n]=r,"_mapping"==n&&e.app.addSpaceGeometryMapping(t,r),e.Event.fire("onSetSpaceData",t,n,r)},t.prototype.Client_delSpaceData=function(t,n){e.INFO_MSG("KBEngineApp::Client_delSpaceData: spaceID("+t+"), key("+n+")!"),delete e.app.spacedata[n],e.Event.fire("onDelSpaceData",t,n)},t.prototype.Client_getSpaceData=function(t,n){return e.app.spacedata[n]},t.prototype.Client_onUpdateBasePos=function(t,n,r){e.app.entityServerPos.x=t,e.app.entityServerPos.y=n,e.app.entityServerPos.z=r},t.prototype.Client_onUpdateBasePosXZ=function(t,n){e.app.entityServerPos.x=t,e.app.entityServerPos.z=n},t.prototype.Client_onUpdateData=function(t){var n=e.app.getViewEntityIDFromStream(t),r=e.app.entities[n];return void 0==r?void e.ERROR_MSG("KBEngineApp::Client_onUpdateData: entity("+n+") not found!"):void 0},t.prototype.Client_onSetEntityPosAndDir=function(t){var n=t.readInt32(),r=e.app.entities[n];return void 0==r?void e.ERROR_MSG("KBEngineApp::Client_onSetEntityPosAndDir: entity("+n+") not found!"):(r.position.x=t.readFloat(),r.position.y=t.readFloat(),r.position.z=t.readFloat(),r.direction.x=t.readFloat(),r.direction.y=t.readFloat(),r.direction.z=t.readFloat(),r.entityLastLocalPos.x=r.position.x,r.entityLastLocalPos.y=r.position.y,r.entityLastLocalPos.z=r.position.z,r.entityLastLocalDir.x=r.direction.x,r.entityLastLocalDir.y=r.direction.y,r.entityLastLocalDir.z=r.direction.z,r.set_direction(r.direction),void r.set_position(r.position))},t.prototype.Client_onUpdateData_ypr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8(),a=t.readInt8(),i=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,a,i,-1)},t.prototype.Client_onUpdateData_yp=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8(),a=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,a,e.KBE_FLT_MAX,-1)},t.prototype.Client_onUpdateData_yr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8(),a=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,e.KBE_FLT_MAX,a,-1)},t.prototype.Client_onUpdateData_pr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8(),a=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,a,-1)},t.prototype.Client_onUpdateData_y=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,e.KBE_FLT_MAX,e.KBE_FLT_MAX,-1)},t.prototype.Client_onUpdateData_p=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,e.KBE_FLT_MAX,-1)},t.prototype.Client_onUpdateData_r=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readInt8();e.app._updateVolatileData(n,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,r,-1)},t.prototype.Client_onUpdateData_xz=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,1)},t.prototype.Client_onUpdateData_xz_ypr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8(),i=t.readInt8(),o=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],a,i,o,1)},t.prototype.Client_onUpdateData_xz_yp=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8(),i=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],a,i,e.KBE_FLT_MAX,1)},t.prototype.Client_onUpdateData_xz_yr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8(),i=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],a,e.KBE_FLT_MAX,i,1)},t.prototype.Client_onUpdateData_xz_pr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8(),i=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],e.KBE_FLT_MAX,a,i,1)},t.prototype.Client_onUpdateData_xz_y=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],a,e.KBE_FLT_MAX,e.KBE_FLT_MAX,1)},t.prototype.Client_onUpdateData_xz_p=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],e.KBE_FLT_MAX,a,e.KBE_FLT_MAX,1)},t.prototype.Client_onUpdateData_xz_r=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readInt8();e.app._updateVolatileData(n,r[0],e.KBE_FLT_MAX,r[1],e.KBE_FLT_MAX,e.KBE_FLT_MAX,a,1)},t.prototype.Client_onUpdateData_xyz=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY();e.app._updateVolatileData(n,r[0],a,r[1],e.KBE_FLT_MAX,e.KBE_FLT_MAX,e.KBE_FLT_MAX,0)},t.prototype.Client_onUpdateData_xyz_ypr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8(),o=t.readInt8(),p=t.readInt8();e.app._updateVolatileData(n,r[0],a,r[1],i,o,p,0)},t.prototype.Client_onUpdateData_xyz_yp=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8(),o=t.readInt8();e.app._updateVolatileData(n,r[0],a,r[1],i,o,e.KBE_FLT_MAX,0)},t.prototype.Client_onUpdateData_xyz_yr=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8(),o=t.readInt8();e.app._updateVolatileData(n,r[0],a,r[1],i,e.KBE_FLT_MAX,o,0)},t.prototype.Client_onUpdateData_xyz_pr=function(t){e.app.getViewEntityIDFromStream(t),t.readPackXZ(),t.readPackY(),t.readInt8(),t.readInt8();e.ERROR_MSG("调用错误方法，无法找到x,z")},t.prototype.Client_onUpdateData_xyz_y=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8();
e.app._updateVolatileData(n,r[0],a,r[1],i,e.KBE_FLT_MAX,e.KBE_FLT_MAX,0)},t.prototype.Client_onUpdateData_xyz_p=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8();e.app._updateVolatileData(n,r[0],a,r[1],e.KBE_FLT_MAX,i,e.KBE_FLT_MAX,0)},t.prototype.Client_onUpdateData_xyz_r=function(t){var n=e.app.getViewEntityIDFromStream(t),r=t.readPackXZ(),a=t.readPackY(),i=t.readInt8();t.readInt8();e.app._updateVolatileData(n,r[0],a,r[1],i,e.KBE_FLT_MAX,e.KBE_FLT_MAX,0)},t.prototype._updateVolatileData=function(t,n,r,a,i,o,p,s){var l=e.app.entities[t];if(void 0==l)return void e.ERROR_MSG("KBEngineApp::_updateVolatileData: entity("+t+") not found!");s>=0&&(l.isOnGround=s>0);var c=!1;p!=e.KBE_FLT_MAX&&(c=!0,l.direction.x=e.int82angle(p,!1)),o!=e.KBE_FLT_MAX&&(c=!0,l.direction.y=e.int82angle(o,!1)),i!=e.KBE_FLT_MAX&&(c=!0,l.direction.z=e.int82angle(i,!1));var d=!1;1==c&&(e.Event.fire("set_direction",l),d=!0);var u=!1;(n!=e.KBE_FLT_MAX||r!=e.KBE_FLT_MAX||a!=e.KBE_FLT_MAX)&&(u=!0),n==e.KBE_FLT_MAX&&(n=0),r==e.KBE_FLT_MAX&&(r=0),a==e.KBE_FLT_MAX&&(a=0),u&&(l.position.x=n+e.app.entityServerPos.x,l.position.y=r+e.app.entityServerPos.y,l.position.z=a+e.app.entityServerPos.z,d=!0,e.Event.fire("updatePosition",l)),d&&l.onUpdateVolatileData()},t.prototype.Client_onStreamDataStarted=function(t,n,r){e.Event.fire("onStreamDataStarted",t,n,r)},t.prototype.Client_onStreamDataRecv=function(t){var n=t.readUint16(),r=t.readBlob();e.Event.fire("onStreamDataRecv",n,r)},t.prototype.Client_onStreamDataCompleted=function(t){e.Event.fire("onStreamDataCompleted",t)},t.prototype.Client_onReqAccountResetPasswordCB=function(t){return 0!=t?void e.ERROR_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+e.app.username+" is failed! code="+e.app.serverErrs[t].name+"!"):void e.INFO_MSG("KBEngineApp::Client_onReqAccountResetPasswordCB: "+e.app.username+" is successfully!")},t.prototype.Client_onReqAccountBindEmailCB=function(t){return 0!=t?void e.ERROR_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+e.app.username+" is failed! code="+e.app.serverErrs[t].name+"!"):void e.INFO_MSG("KBEngineApp::Client_onReqAccountBindEmailCB: "+e.app.username+" is successfully!")},t.prototype.Client_onReqAccountNewPasswordCB=function(t){return 0!=t?void e.ERROR_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+e.app.username+" is failed! code="+e.app.serverErrs[t].name+"!"):void e.INFO_MSG("KBEngineApp::Client_onReqAccountNewPasswordCB: "+e.app.username+" is successfully!")},t}();e.KBEngineApp=r,__reflect(r.prototype,"KBEngine.KBEngineApp");var a=function(){function e(){this.name="",this.descr="",this.id=0}return e}();e.ServerErr=a,__reflect(a.prototype,"KBEngine.ServerErr");var i;e.create=t,e.destroy=n}(KBEngine||(KBEngine={}));